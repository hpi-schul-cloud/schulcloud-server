apiVersion: v1
kind: ConfigMap
metadata:
  name: api-init-file
  namespace: {{ NAMESPACE }}
  labels:
    app: api-deployment
data:
  update.sh: |
    #! /bin/bash
    until mongo $DATABASE__URL --eval "print(\"waited for connection\")"
      do
        sleep 1
      done
    mongo $DATABASE__URL --eval 'rs.initiate({"_id" : "rs0", "members" : [{"_id" : 0, "host" : "localhost:27017"}]})'
    sleep 3
    if [[ $(mongo --quiet --eval "db.isMaster().setName") != rs0 ]]
    then
        echo "replicaset config failed :("
    else
        echo "gg, hacky mongo replicaset"
    fi
    curl --retry 360 --retry-connrefused --retry-delay 10 -X POST 'http://mgmt-svc:3333/api/management/database/seed?with-indexes=true'
    IDM_ACTIVE={{ WITH_ERWINIDM }}
    if [[ ${IDM_ACTIVE,,} == true ]]
    then
      curl --retry 360 --retry-connrefused --retry-delay 10 -X POST 'http://mgmt-svc:3333/api/management/idm/seed'
    else
      echo "Skip IDM initialization"
    fi