name: Require CHANGELOG.md update

on:
  pull_request:
    branches:
      # filter target branch of pr
      - develop
      - master

jobs:
  FeatureOrHotfix:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    steps:
      - name: continue only iff this is a feature or hotfix pr
        if: startsWith(${{ github.head_ref }}, 'feature') == false && startsWith(${{ github.head_ref }}, 'hotfix') == false
        id: enabled
        run: |
          echo "This check is required for merging into develop and master but takes in action only for pr's from feature or hotfix branches."
          echo "::set-output name=enabled::true"
      - name: current branch will be checked (otherwise ignored)
        run: ${{ steps.enabled.outputs.enabled }}
      - name: Get Changed Files
        id: changed
        uses: foodee/pr-includes-file-change@master
        with:
          paths: ^CHANGELOG.md
      - name: current head branch name
        run: echo ${{ github.head_ref }}
      - name: Changelog has been updated
        if: steps.changed.outputs.matched == 'true'
        run: |
          echo ${{ steps.changed.outputs.matched }}
          echo "Changes in CHANGELOG.md have been found"
          exit 0
      - name: Changelog updates missing
        if: steps.changed.outputs.matched != 'true' && steps.enabled.outputs.enabled == 'true'
        run: |
          echo ${{ steps.changed.outputs.matched }}
          echo "Features and Hotfixes must contain a changelog entry."
          echo "Add meaningful information into CHANGELOG.md about this PR."
          exit 1
