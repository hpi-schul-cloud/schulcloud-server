name: Migrations updated

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  MONGODB_VERSION: 4.4
  NODE_VERSION: '18'
jobs:
  migration:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    steps:
    - uses: actions/checkout@v4
    - name: mongodb setup
      uses: supercharge/mongodb-github-action@1.10.0
    - name: setup
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    - run: npm ci
    - run: npm run setup:db:seed
    - name: check no pending migrations (migration is in db)
      run: test $(npm run migration:pending | grep -c "Migration") -eq 0
