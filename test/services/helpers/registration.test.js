'use strict';
const assert = require('assert');
const app = require('../../../src/app');
const registrationService = app.service('registration');
const registrationPinService = app.service('registrationPins');
const userModel = require('../../../src/services/user/model');
const chai = require('chai');

describe('registration service', function() {
    it('registered the registration service', () => {
        assert.ok(registrationService);
    });

    it('processes registration by student correctly', () => {
        let email = 'max' + Date.now() + '@mustermann.de';
        return registrationPinService.create({"email": email})
        .then(registrationPin => {
            let registrationInput = {
                classOrSchoolId: "0000d186816abba584714c5f",
                pin: registrationPin.pin,
                password_1: "pw123",
                password_2: "pw123",
                gender: "male",
                birthDate: "15.10.1999",
                email: email,
                firstName: "Max",
                lastName: "Mustermann",
                privacyConsent: true,
                researchConsent: true,
                thirdPartyConsent: true,
                termsOfUseConsent: true
            };
            return registrationService.create(registrationInput);
        })
        .then(response => {
            chai.expect(response.user).to.have.property("_id");
            chai.expect(response.account).to.have.property("_id");
            chai.expect(response.consent).to.have.property("_id");
            chai.expect(response.consent).to.have.property("userConsent");
            chai.expect(response.parent).to.equal(null);
        });
    });

    it('processes registration by parent correctly', () => {
        let email = 'moritz' + Date.now() + '@mustermann.de';
        return registrationPinService.create({"email": email})
        .then(registrationPin => {
            let registrationInput = {
                classOrSchoolId: "0000d186816abba584714c5f",
                pin: registrationPin.pin,
                gender: "male",
                password_1: "pw123",
                password_2: "pw123",
                birthDate: "15.10.2014",
                email: 'max' + Date.now() + '@mustermann.de',
                firstName: "Max",
                lastName: "Mustermann",
                privacyConsent: true,
                researchConsent: true,
                thirdPartyConsent: true,
                termsOfUseConsent: true,
                parent_email: email,
                parent_firstName: "Moritz",
                parent_lastName: "Mustermann"
            };
            return registrationService.create(registrationInput);
        })
        .then(response => {
            chai.expect(response.user).to.have.property("_id");
            chai.expect(response.account).to.have.property("_id");
            chai.expect(response.consent).to.have.property("_id");
            chai.expect(response.consent.parentConsents.length).to.be.at.least(1);
            chai.expect(response.parent).to.have.property("_id");
            chai.expect(response.user.parents).to.include(response.parent._id);
            chai.expect(response.parent.children).to.include(response.user._id);
        });
    });

    it('fails with invalid pin', () => {
        let email = 'max' + Date.now() + '@mustermann.de';
        return registrationPinService.create({"email": email})
        .then(registrationPin => {
            let pin = Number(registrationPin.pin);
            pin = pin == 9999 ? 1000 : pin + 1;
            //make sure we pass a wrong pin
            return registrationService.create({
                classOrSchoolId: "0000d186816abba584714c5f",
                pin: String(pin),
                gender: "male",
                birthDate: "15.10.1999",
                email: email,
                firstName: "Max",
                lastName: "Mustermann",
            });
        }).catch(err => {
            chai.expect(err).to.be.not.undefined;
            chai.expect(err.message).to.equal("Ung端ltige Pin, bitte 端berpr端fe die Eingabe.");
        });
    });

    it('fails if parent and student email are the same', () => {
        return registrationService.create({
            classOrSchoolId: "0000d186816abba584714c5f",
            email: "max.sameadress@mustermann.de",
            parent_email: "max.sameadress@mustermann.de",
            birthDate: "18.02.2015"
        }).catch(err => {
            chai.expect(err.message).to.equal("Bitte gib eine unterschiedliche E-Mail-Adresse f端r dein Kind an.");
        });
    });

    it('undoes changes on fail', () => {
        let email = 'max' + Date.now() + '@mustermann.de';
        return registrationPinService.create({"email": email})
        .then(registrationPin => {
            let registrationInput = {
                classOrSchoolId: "0000d186816abba584714c5f",
                pin: registrationPin.pin,
                gender: "male",
                birthDate: "15.10.1999",
                email: email,
                firstName: "Max",
                lastName: "Mustermann",
                privacyConsent: true,
                researchConsent: true,
                thirdPartyConsent: true,
                termsOfUseConsent: true
            };
            return registrationService.create(registrationInput).catch(err => {
                //no password given, should result in an error.
                chai.expect(err.message).to.equal("Fehler beim Erstellen des Accounts.");
                //a user has been created before the error. Lets check if he was deleted...
                return userModel.userModel.findOne({email: email});
            }).then(users => {
                chai.expect(users).to.equal(null);
            });
        });
    });

    it('processes teachers correctly', () => {
        let email = 'max' + Date.now() + '@mustermann.de';
        let hash, user;
        let hashData = {
            toHash: email,
            save: true
        };
        return app.service('hash').create(hashData)
        .then(newHash => {
            hash = newHash;
            return userModel.userModel.create({
                email: email,
                firstName: "Max",
                lastName: "Mustermann",
                schoolId: "0000d186816abba584714c5f",
                roles: ["0000d186816abba584714c98"],//teacher
                importHash: hash
            });
        }).then(newUser => {
            user = newUser;
            return registrationPinService.create({"email": email});
        }).then(registrationPin => {
            let registrationInput = {
                classOrSchoolId: "0000d186816abba584714c5f",
                pin: registrationPin.pin,
                password_1: "pw123",
                password_2: "pw123",
                email: email,
                firstName: "Max",
                lastName: "Mustermann",
                importHash: hash,
                userId: user._id,
                privacyConsent: true,
                researchConsent: true,
                thirdPartyConsent: true,
                termsOfUseConsent: true
            };
            return registrationService.create(registrationInput).then(response => {
                chai.expect(response.user).to.have.property("_id");
                chai.expect(response.account).to.have.property("_id");
                chai.expect(response.consent).to.have.property("_id");
                chai.expect(response.consent).to.have.property("userConsent");
                chai.expect(response.parent).to.equal(null);
            });
        });
    });
});
